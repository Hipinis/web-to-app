name: Manual Build Pro APK
on:
  workflow_dispatch: # 在 GitHub Actions 页面提供一个手动的 "Run workflow" 按钮

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出源码
        uses: actions/checkout@v4

      - name: 配置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 生产准备：下载并提纯 11.txt 广告规则
        run: |
          # 1. 确保资产目录存在
          mkdir -p app/src/main/assets
          
          # 2. 下载 AdGuard 11.txt 原始规则
          curl -L "https://filters.adtidy.org/extension/chromium/filters/11.txt" -o raw_rules.txt
          
          # 3. 使用 Python 将庞大的规则加工成原生代码可识别的轻量文件
          python3 -c "
          import os
          ad_domains = set()
          css_selectors = set()
          
          try:
              with open('raw_rules.txt', 'r', encoding='utf-8') as f:
                  for line in f:
                      line = line.strip()
                      # 跳过空行和注释
                      if not line or line.startswith('!') or line.startswith('['):
                          continue
                      
                      # 提取 CSS 视觉隐藏规则 (##)
                      if '##' in line:
                          parts = line.split('##', 1)
                          selector = parts[1]
                          # 简单过滤掉复杂的 JS 脚本型规则，只保留纯 CSS 选择器
                          if '{' not in selector and ':has(' not in selector:
                              css_selectors.add(selector)
                      
                      # 提取网络拦截规则 (||domain^)
                      elif line.startswith('||'):
                          domain = line[2:].split('^')[0].split('$')[0].split('/')[0]
                          if domain and '.' in domain:
                              ad_domains.add(domain)
          except Exception as e:
              print(f'加工规则出错: {e}')

          # 写入网络黑名单 (TXT格式)
          with open('app/src/main/assets/adblock_rules.txt', 'w', encoding='utf-8') as f:
              f.write('\n'.join(sorted(list(ad_domains))))
          
          # 写入视觉隐藏样式表 (CSS格式)
          with open('app/src/main/assets/adblock.css', 'w', encoding='utf-8') as f:
              if css_selectors:
                  # 所有的选择器强制设为隐藏
                  f.write(','.join(list(css_selectors)) + ' { display: none !important; visibility: hidden !important; height: 0 !important; width: 0 !important; pointer-events: none !important; }')
          "
          echo "✅ 规则提纯完成：assets/adblock_rules.txt 和 adblock.css 已就绪"

      - name: 赋予编译脚本权限
        run: chmod +x gradlew

      - name: 执行原生 Android 编译 (Debug)
        run: ./gradlew assembleDebug

      - name: 交付成品 APK
        uses: actions/upload-artifact@v4
        with:
          name: WebToApp_Pro_Build
          path: app/build/outputs/apk/debug/*.apk
