name: Native App Production
on:
  repository_dispatch:
    types: [start_build] # 接收来自 Vercel 的生产指令

jobs:
  build_android:
    runs-on: ubuntu-latest
    steps:
      - name: 检出原生代码
        uses: actions/checkout@v4

      - name: 配置 Java 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 核心二开：注入广告拦截引擎与动态网址
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          # 1. 自动下载并解析三大权威广告规则库 (11.txt 等)
          python3 -c "
          import urllib.request, json, os
          payload = json.loads(os.environ['PAYLOAD'])
          target_urls = [
              'https://filters.adtidy.org/extension/chromium/filters/11.txt',
              'https://filters.adtidy.org/extension/chromium/filters/2.txt',
              'https://easylist-downloads.adblockplus.org/easylistchina.txt'
          ]
          ad_domains = set()
          for url in target_urls:
              try:
                  lines = urllib.request.urlopen(url, timeout=15).read().decode('utf-8').splitlines()
                  for line in lines:
                      if line.startswith('||') and '^' in line:
                          d = line[2:].split('^')[0].split('$')[0]
                          if d: ad_domains.add(d)
              except: pass
          os.makedirs('app/src/main/assets', exist_ok=True)
          with open('app/src/main/assets/adblock_rules.txt', 'w') as f: f.write('\n'.join(ad_domains))
          "

          # 2. 物理级修复状态栏重叠：修改所有 activity 布局文件
          find app/src/main/res/layout -name "*.xml" -exec sed -i 's/android:layout_width=\"match_parent\"/android:layout_width=\"match_parent\" android:fitsSystemWindows=\"true\"/g' {} +

      - name: 赋予编译权限并执行锻造
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: 交付原生 APK 成品
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}_Native_Pro
          path: app/build/outputs/apk/debug/*.apk
